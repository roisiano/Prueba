name: Build astra-sm IPK for CoreELEC (aarch64 & armv7)

on:
  workflow_dispatch:

jobs:
  build-aarch64:
    name: Build for aarch64
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          fakeroot \
          git \
          binutils \
          libdvbcsa-dev \
          libssl-dev

    - name: Clone and prepare astra-sm (verbose + log)
      run: |
        set -x
        set -e
        git clone https://github.com/crazycat69/astra-sm.git
        cd astra-sm
        libtoolize --force
        aclocal
        autoheader
        automake --add-missing
        autoconf

        # Crear log vacío antes de compilar
        touch $GITHUB_WORKSPACE/build.log

        # Compilar y guardar salida en el log
        make -j$(nproc) 2>&1 | tee -a $GITHUB_WORKSPACE/build.log || true

        # Crear destino en el paquete y copiar binario
        mkdir -p $GITHUB_WORKSPACE/ipk-root/opt/bin
        cp src/astra/astra $GITHUB_WORKSPACE/ipk-root/opt/bin/astra-sm || true

    - name: Upload build log (always)
      uses: actions/upload-artifact@v4
      with:
        name: build-log-aarch64
        path: ${{ github.workspace }}/build.log

    - name: Verify installation output
      run: |
        echo "📦 Contenido de ipk-root:"
        ls -lR ipk-root || echo "⚠️ ipk-root no existe"

    - name: Create IPK structure (aarch64)
      run: |
        mkdir -p ipk-package/control
        mkdir -p ipk-package/data

        echo "Package: astra-sm" > ipk-package/control/control
        echo "Version: $(date +%Y.%m.%d)" >> ipk-package/control/control
        echo "Architecture: aarch64" >> ipk-package/control/control
        echo "Maintainer: CrazyCat <crazycat69@github>" >> ipk-package/control/control
        echo "Description: Astra Streaming Manager (crazycat69 fork)" >> ipk-package/control/control
        echo "Section: net" >> ipk-package/control/control
        echo "Priority: optional" >> ipk-package/control/control
        echo "Homepage: https://github.com/crazycat69/astra-sm" >> ipk-package/control/control
        echo "Depends: libc, libssp, librt, libpthread, libdvbcsa, libopenssl" >> ipk-package/control/control

        if [ ! -d "ipk-root/opt" ]; then
          echo "❌ Error: ipk-root no contiene archivos instalados. La compilación puede haber fallado."
          exit 1
        fi

        cd ipk-root
        tar czf ../ipk-package/data.tar.gz .
        cd ../ipk-package/control
        tar czf ../control.tar.gz .
        cd ../
        echo "2.0" > ipk-package/debian-binary

    - name: Build .ipk (aarch64)
      run: |
        cd ipk-package
        ar r astra-sm_$(date +%Y.%m.%d)_aarch64.ipk debian-binary control.tar.gz data.tar.gz

    - name: Upload IPK (aarch64)
      uses: actions/upload-artifact@v4
      with:
        name: astra-sm-aarch64
        path: ipk-package/*.ipk

  build-armv7:
    name: Build for armv7
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          fakeroot \
          git \
          binutils \
          gcc-arm-linux-gnueabihf \
          libdvbcsa-dev \
          libssl-dev

    - name: Clone and prepare astra-sm (verbose + log)
      run: |
        set -x
        set -e
        git clone https://github.com/crazycat69/astra-sm.git
        cd astra-sm
        libtoolize --force
        aclocal
        autoheader
        automake --add-missing
        autoconf

        # Crear log vacío antes de compilar
        touch $GITHUB_WORKSPACE/build.log

        # Compilar y guardar salida en el log
        make -j$(nproc) 2>&1 | tee -a $GITHUB_WORKSPACE/build.log || true

        # Crear destino en el paquete y copiar binario
        mkdir -p $GITHUB_WORKSPACE/ipk-root/opt/bin
        cp src/astra/astra $GITHUB_WORKSPACE/ipk-root/opt/bin/astra-sm || true

    - name: Upload build log (always)
      uses: actions/upload-artifact@v4
      with:
        name: build-log-armv7
        path: ${{ github.workspace }}/build.log

    - name: Verify installation output
      run: |
        echo "📦 Contenido de ipk-root:"
        ls -lR ipk-root || echo "⚠️ ipk-root no existe"

    - name: Create IPK structure (armv7)
      run: |
        mkdir -p ipk-package/control
        mkdir -p ipk-package/data

        echo "Package: astra-sm" > ipk-package/control/control
        echo "Version: $(date +%Y.%m.%d)" >> ipk-package/control/control
        echo "Architecture: armv7" >> ipk-package/control/control
        echo "Maintainer: CrazyCat <crazycat69@github>" >> ipk-package/control/control
        echo "Description: Astra Streaming Manager (crazycat69 fork)" >> ipk-package/control/control
        echo "Section: net" >> ipk-package/control/control
        echo "Priority: optional" >> ipk-package/control/control
        echo "Homepage: https://github.com/crazycat69/astra-sm" >> ipk-package/control/control
        echo "Depends: libc, libssp, librt, libpthread, libdvbcsa, libopenssl" >> ipk-package/control/control

        if [ ! -d "ipk-root/opt" ]; then
          echo "❌ Error: ipk-root no contiene archivos instalados. La compilación puede haber fallado."
          exit 1
        fi

        cd ipk-root
        tar czf ../ipk-package/data.tar.gz .
        cd ../ipk-package/control
        tar czf ../control.tar.gz .
        cd ../
        echo "2.0" > ipk-package/debian-binary

    - name: Build .ipk (armv7)
      run: |
        cd ipk-package
        ar r astra-sm_$(date +%Y.%m.%d)_armv7.ipk debian-binary control.tar.gz data.tar.gz

    - name: Upload IPK (armv7)
      uses: actions/upload-artifact@v4
      with:
        name: astra-sm-armv7
        path: ipk-package/*.ipk


