name: Build Zerotier 1.14.1 Patched for CoreELEC

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        target: [ng, ne]

    steps:
      - name: Checkout Zerotier 1.14.1
        uses: actions/checkout@v4
        with:
          repository: zerotier/ZeroTierOne
          ref: 1.14.1

      - name: Debug repo
        run: |
          echo "Repo contents:"
          ls -R .

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y build-essential clang pkg-config libssl-dev

      - name: Apply compatibility patches
        run: |
          set -e
          set -x

          # Archivos que cambian entre versiones
          FILES="
            osdep/LinuxEthernetTap.cpp
            osdep/LinuxNetLink.cpp
            osdep/LinuxNetDev.cpp
          "

          for f in $FILES; do
            if [ -f "$f" ]; then
              echo "Patching $f"
              sed -i 's/#define ZT_USE_LINUX_NETLINK_MULTIQUEUE/\/\/ removed for CE/g' "$f" || true
              sed -i 's/#define ZT_USE_LINUX_RTNETLINK_EXTENDED/\/\/ removed for CE/g' "$f" || true
              sed -i 's/#define ZT_USE_LINUX_BPF/\/\/ removed for CE/g' "$f" || true
              sed -i 's/#define ZT_USE_LINUX_NFTABLES/\/\/ removed for CE/g' "$f" || true
            else
              echo "Skipping missing file: $f"
            fi
          done

          # Flags por kernel
          if [ "${{ matrix.target }}" = "ng" ]; then
            echo "CFLAGS=-DZT_LEGACY_KERNEL -O2" >> $GITHUB_ENV
          else
            echo "CFLAGS=-DZT_MID_KERNEL -O2" >> $GITHUB_ENV
          fi

      - name: Build static binary
        run: |
          set -e
          set -x
          echo "Using CFLAGS=$CFLAGS"
          make clean
          make ZT_STATIC=1

      - name: Create IPK structure
        run: |
          set -e
          set -x
          mkdir -p pkg/CONTROL
          mkdir -p pkg/opt/bin
          cp zerotier-one pkg/opt/bin/

          CONTROL_FILE=pkg/CONTROL/control
          echo "Package: zerotier-${{ matrix.target }}" > "$CONTROL_FILE"
          echo "Version: 1.14.1-patched" >> "$CONTROL_FILE"
          echo "Architecture: aarch64" >> "$CONTROL_FILE"
          echo "Description: Zerotier 1.14.1 patched for CoreELEC ${{ matrix.target }}" >> "$CONTROL_FILE"

      - name: Build IPK
        run: |
          set -e
          set -x
          cd pkg
          tar -czf control.tar.gz CONTROL
          tar -czf data.tar.gz opt
          echo "2.0" > debian-binary
          ar r ../zerotier-${{ matrix.target }}.ipk debian-binary control.tar.gz data.tar.gz

      - name: Upload IPK
        uses: actions/upload-artifact@v4
        with:
          name: zerotier-${{ matrix.target }}.ipk
          path: zerotier-${{ matrix.target }}.ipk


